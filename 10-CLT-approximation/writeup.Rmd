---
title: "10-CLT-approximation"
author: Yasi Wang
date: 11/10/2019
output: 
  html_notebook: 
    highlight: tango
    theme: cosmo
---

# Introduction
***

**Central limit theorem** is an important computational short-cut for generating and making inference from the sampling distribution of the mean. It states that if you take sufficiently large random samples from the population with replacement, the distribution of the sample means will be approximately normally distributed, even if the original variables themselves are not normally distributed. Central limit theorem relies on the following conditions:

- Independent observations
- Identically distributed observations
- Mean and variance exist
- Sample size large enough for convergence

The theorem is a key concept in probability theory because it implies that probabilistic and statistical methods that work for normal distributions can be applicable to many problems involving other types of distributions.

In this blog, I am going to compare the sampling distribution of the mean generated by simulation to the sampling distribution implied by the central limit theorem. QQ-plot will be demonstrated for comparison.

# Simulation
***

```{r include=FALSE}
require(magrittr)
require(sn)
```

## Parameters of interest

I'll design a 4 X 4 factorial experiment. The first factor will be the **sample size**, with `N = 5, 10, 20, and 40`. The second factor will be the **degree of skewness** in the underlying distribution. The underlying distribution will be the Skew-Normal distribution. The Skew-Normal distribution has three parameters: **location**, **scale**, and **slant**. When the slant parameter is 0, the distribution reverts to the normal distribution. As the slant parameter increases, the distribution becomes increasingly skewed. In this simulation, **slant** will be set to `0, 2, 10, 100`. Set `location = 0` and `scale = 1`, for all simulation settings.


```{r}
# parameters that do not change
R <- 5000
location <- 0
scale <- 1

# parameters that change
slant = c(0, 2, 10, 100)
N = c(5, 10, 20, 40)

```


## Simulation process (n = 5, slant = 10)

Now I will use two methods to generate the sampling distribution of the mean. Let's look at an example first. Assuming that we have N = 5 and slant = 10, we can get the population mean and standard deviation:

```{r}
N_eg <- 5
slant_eg <- 10
delta <- slant_eg/(sqrt(1 + slant_eg^2))

# Quantiles to calculate/generate
pop_mean <- location + scale*delta*(sqrt(2/pi))
pop_sd <- sqrt(scale^2*(1-((2*delta^2)/pi)))

```

### 1) by simulation:
```{r}
random.skew <- array(rsn(R * N_eg, xi = location, omega = scale, alpha = slant_eg), dim = c(R, N_eg))
sample_dist_sim <- apply(random.skew, 1, mean)
```

### 2) by the central limit theorem:
```{r}
Z <- rnorm(R)
sample_dist_clt <- Z*(pop_sd/sqrt(N_eg)) + pop_mean
```

I generated the sampling distribution of the mean by the above two methods, and created the corresponding density plot.
```{r fig.width=10}
par(mfrow = c(1, 2))
plot(density(sample_dist_sim), xlab = "Mean", main = "Sampling distribution of the mean by simulation", lwd = 2)
plot(density(sample_dist_clt), xlab = "Mean", main = "Sampling distribution of the mean by CLT", lwd = 2)

```

### 3) Q-Q plot

Using the qqplot, we can find that the points don't lie on the the reference line perfectly. The curved pattern suggests that the central quantiles are more closely spaced in CLT methods than in simulation method, and that the sampling distribution of the mean by CLT method is skewed to the left compared to the simulation method.
```{r}
qqplot(sample_dist_sim, sample_dist_clt, asp = 1, xlab  = "Simulation Quantiles", ylab = "Central limit theorem Quantiles", main = "QQ plot (N = 5, slant = 10)")
abline(0, 1)
```

## ALl together
Now we combined all the conditions together. Let's see the results. 

```{r fig.width=11, fig.height=12}
par(mfrow = c(4, 4))

for (i in seq(1, 4)){
  for (j in seq(1, 4)){
    delta <- slant[i]/(sqrt(1 + slant[i]^2))
    pop_mean <- location + scale*delta*(sqrt(2/pi))
    pop_sd <- sqrt(scale^2*(1-((2*delta^2)/pi)))
    
    Z <- rnorm(R)
    sample_dist_clt <- Z*(pop_sd/sqrt(N[j])) + pop_mean
    random.skew <- array(rsn(R * N[j], xi = location, omega = scale, alpha = slant[i]), dim = c(R, N[j]))
    sample_dist_sim <- apply(random.skew, 1, mean)

    qqplot(sample_dist_sim, sample_dist_clt, asp = 1, xlab  = "Simulation Quantiles",
           ylab = "CLT Quantiles", main=paste("N = ", N[j], " and Slant = ", slant[i]))
    abline(0, 1)

  }
}
```
Looking at the graphs, we can find that:

- When slant = 0, the mean of the sampling distribution comparatively have the greater range, from -1.5 to 2.
- When N is fixed (e.g. N = 5), as the slant parameter increases, the two distributions are more likely to come from different populations.
- When slant is fixed (e.g. slant = 100), as the sample size increases, the two distributions are more likely to come from the same population, which means that the result is more stable whatever the methods are used.


# Conclusion
***
According to the simulation, we can conclude that:

1) If the population are more likely to be normally distributed, the points in the QQ plot of the sampling distribution of the mean using both methods are more likely to lie in the reference line, which means that they are more likely to come from the same population.

2) If the sample size increase, the result will be more stable, which means the CLT method and simulation method are more likely to generate the sampling distribution which are from the same population.

3) Thus, when we don't know the skewness of the original distribution of the population, we want the sample size large enough to ensure that the central limit theorem works well.

# Bonus
***
When the mean and variance parameters are estimated from data, instead of using the population parameters, let's see what will happen.

```{r eval=FALSE, fig.height=12, fig.width=11, include=FALSE}
require(tidyverse)

par(mfrow = c(4, 4))

for (i in seq(1, 4)){
  for (j in seq(1, 4)){
    delta <- slant[i]/(sqrt(1 + slant[i]^2))
    
    Y <- rsn(R, xi = location, omega = scale, alpha = slant[i])
    
    est.mean = mean(Y)
    est.sd <- sqrt(sum((Y-est.mean)^2/(length(Y)-1)))
    
    Z <- rnorm(R)

    sample_dist_clt <- Z*(est.sd/sqrt(N[j])) + est.mean
    random.skew <- array(rsn(R * N[j], xi = location, omega = scale, alpha = slant[i]), dim = c(R, N[j]))
    sample_dist_sim <- apply(random.skew, 1, mean)

    qqplot(sample_dist_sim, sample_dist_clt, asp = 1, xlab  = "Simulation Quantiles",
           ylab = "CLT Quantiles", main=paste("N = ", N[j], " and Slant = ", slant[i]))
    abline(0, 1)

  }
}

```

